<html>

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Title -->
        <title>shymonk</title>

        <!-- CSS -->
            <link href="/theme/css/bootstrap.min.css" rel="stylesheet">
            <link href="/theme/css/clean-blog.min.css" rel="stylesheet">
            <link href="/theme/css/code_blocks/darkly.css" rel="stylesheet">
            <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">




        <meta name="tags" contents="stackless" />
        <meta name="tags" contents="python" />

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Home</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                        <li><a href="/archives.html">Archives</a></li>
                        <li><a href="/about.html">About</a></li>

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/theme/images/post-bg.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Stackless Python 探秘</h1>
                        <span class="meta">Posted by
                                <a href="/author/shymonk.html">shymonk</a>
                             on 2016-06-01 22:00
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <article>
        <p>提到stackless python， 相信很多人早已对其有所耳闻。作为Python解释器的另一种实现，其设计思路对整个Python世界产生了
深远影响。坦白的讲，我并没有大规模stackless python 的应用经验，本文意在对其背后实现原理进行探索。如果你和我一样对它感到好奇，欢迎深入阅读。</p>
<h1>stackless历史</h1>
<ul>
<li>1998年， 作者Christian Tismer便开始了Stackless Python 1.0版本的开发。作为雏形版本， Tismer 首次在Python中加入了<code>continuation</code> 这一抽象概念的实现。</li>
<li>2000年，以Stackless Python为背景的<a href="https://www.python.org/dev/peps/pep-0219/">PEP 0219</a> 出现了。根据PEP的描述，Tismer希望Stackless 相关的代码能够成为Python核心的一部分。然而，他的这一提议在Python开发者当中备受争议。出于代码简洁性的考虑，一些开发者认为 stackless相关代码虽然功能强大但是晦涩难懂并且难以维护，加之其对于Jython并不兼容。最终，这一提议没有成为现实。</li>
<li>2002年，Stackless Python 2.0版本诞生。在这一版本中，Tismer彻底重写了代码并放弃了原有的<code>continuation</code> 实现。取而代之的是一种新的"一次性"<code>continuation</code> - <code>tasklets</code> 。</li>
<li>2004年，Stackless Python 3.0版本诞生。它包含2.0版本的全部功能并加入了一个重要概念： <code>soft-switching</code> 用于将程序的执行状态序列化（Pickling of Program State）。</li>
</ul>
<p>其实，早在1999年stackless PEP被提出之前，Python核心开发者Sam Rushing便开发了一个直接通过切换<code>C-Stack</code> 实现的协程模块。然而，与stackless 一样，Python开发人员一致认为其不应该合并到Python核心代码中。理由很简单：由于各硬件平台和编译器对于<code>C-Stack</code> 的处理不尽相同，对于Python这样一种跨平台语言来说，添加平台依赖的代码将大大增加其移植的难度。
经过多年的发展，如今的Stackless Python已经摆脱了当初的麻烦。作为一个与<code>CPython</code>完全兼容的Package 被广大Python用户所使用。正如Tismer所说，"现在的Stackless只提供最干净的概念——<code>Microthreads</code>， 至于那些对稀奇古怪事物不感兴趣的人根本不会真正认识Stackless，只是碰巧它更快。"</p>
<h1>为什么使用stackless?</h1>
<p>关于stackless，不得不提到<a href="https://en.wikipedia.org/wiki/Coroutine">协程(coroutine)</a>。对于大规模并发程序，传统的并发接口线程(Thread)和进程(Process)都有着较大的系统资源开销。与其相比，协程是一种更为自然并且低开销的并发解决方案。它被广泛应用于模拟器、游戏、异步IO以及其他事件驱动的编程模型中。然而，Python2.2之前的版本并没有实现对协程的支持，stackless的诞生正是为了解决这个问题。</p>
<h1>并发模型</h1>
<p><img alt="coroutine concurrency model" src="/images/concurrency-model.png"></p>
<p>并发系统从本质上讲，是一系列独立的执行单元（<code>routine</code>）在调度器的调度之下交替执行。与线程相比，协程并发模型与其最大不同之处在于：</p>
<blockquote>
<p>协程由应用程序实现调度，线程由操作系统实现调度</p>
</blockquote>
<p>由于协程作为执行单元并发执行时，会因为主动放弃执行权限而被挂起，调度系统必须同时维护多个函数执行上下文，以实现非本地跳转（non-local jump）。</p>
<h1>stackless是如何工作的?</h1>
<h2>Stackfull Python</h2>
<p>为了更好的理解<code>stackless</code>，我们以下面这段代码为例，先简要介绍<code>stackfull</code>的<code>C-Python</code>解释器栈结构以及它是如何工作的。</p>
<div class="highlight"><pre><span></span><code>def a(x):
    b(x + 1)

def b(x):
    c(x * x)

def c(x):
    print &#39;x=&#39;, x

a(42)
</code></pre></div>

<p>在Python shell中执行上面这段代码时，解释器中<code>C-stack</code>和<code>Python-stack</code>结构如下图。</p>
<p><img alt="standard 'stackfull' python" src="/images/stackfull-python.png"></p>
<p>Python虚拟机以<code>eval_code2</code>作为解释函数执行<code>a</code>时，首先通过<code>PyFrame_New</code>构造<code>a</code>的栈帧<code>frame-a</code>并返回<code>eval_code2</code>，然后执行<code>a</code>对应的Python代码。由于<code>a</code>嵌套调用<code>b</code>，此时解释器递归调用<code>eval_code2</code>并重复之前过程执行<code>b</code>，从而形成<code>C-stack</code>和由<code>PyFrameObject</code>构成的<code>python-stack</code>。</p>
<h2>范式转换</h2>
<p>对于<code>stackfull</code>的标准Python而言，实现协程并发的核心在于将<code>Python-Stack</code> 与 <code>C-Stack</code>解耦，这种改变Python解释器执行过程的方法也被称作<strong>范式转换</strong>。要点可以归纳为以下三个方面：</p>
<p>1.函数栈帧执行时机    解释器执行<code>Python</code>函数的标准范式是：为函数的<code>PyCodeObject</code>构造一个函数栈帧<code>PyFrameObject</code>并附带所有参数，最后通过<code>eval_code2</code>解释执行相应的函数体直到其返回。</p>
<p>然而，以正确的调用顺序执行所有的函数栈帧并不意味着我们必须在当前<code>C-stack</code>嵌套层级中执行<code>eval_code2</code>。如果我们能够避免与<code>C-stack</code>相关的所有后续操作，就可以在函数栈帧执行前实现<code>C-stack</code>的退栈操作，从而达到解耦的目的。</p>
<p>2.参数生命周期
在标准python中，函数参数的引用由其上层调用者持有。这意味着只有下层函数返回后，其参数元组的引用才能被上层函数销毁。</p>
<p>现在，让我们换一种思维方式。很明显，函数参数应该与函数栈帧有着相同的生命周期，参数元组的引用也应该同函数栈帧一起被销毁。所以，我们在<code>PyFrameObject</code>结构中添加对参数元组的引用，就可以实现范式的转换。</p>
<p>3.系统状态
在标准python中，执行一个函数栈帧后的返回值会存在两种情况：</p>
<ol>
<li>返回<code>PyObject</code>代表函数正常执行。</li>
<li>返回<code>NULL</code>代表函数抛出异常。</li>
</ol>
<p>基于这两种基本系统状态，添加一个特殊的返回值类型<code>Py_UnwindToken</code>作为第三种系统状态，这样我们便可以在下层栈帧被执行之前实现<code>C-stack</code>退栈操作。</p>
<p>由于<code>Py_UnwindToken</code>与其他Python对象兼容，这一范式的转换对于大部分相关代码并不可见，我们只需要对执行栈帧的C函数做出修改即可。</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Return Value</th>
<th style="text-align: left;">系统状态</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">NULL</td>
<td style="text-align: left;">函数执行异常</td>
</tr>
<tr>
<td style="text-align: left;">Py_UnwindToken</td>
<td style="text-align: left;">调度函数栈帧</td>
</tr>
<tr>
<td style="text-align: left;">Other PyObject</td>
<td style="text-align: left;">作为正常结果返回</td>
</tr>
</tbody>
</table>
<h1>参考资料</h1>
<ul>
<li><a href="http://archive.is/TwQEJ">http://archive.is/TwQEJ</a></li>
<li><a href="https://web.archive.org/web/20131005114137/http://www.onlamp.com/pub/a/python/2000/10/04/stackless-intro.html">https://web.archive.org/web/20131005114137/http://www.onlamp.com/pub/a/python/2000/10/04/stackless-intro.html</a></li>
<li><a href="http://www.onlamp.com/pub/a/python/2002/02/14/pythonnews.html">http://www.onlamp.com/pub/a/python/2002/02/14/pythonnews.html</a></li>
<li><a href="https://web.archive.org/web/20120508092636/http://islab.org/stackless/2007/stackless.html">https://web.archive.org/web/20120508092636/http://islab.org/stackless/2007/stackless.html</a></li>
<li><a href="https://ep2013.europython.eu/conference/talks/the-story-of-stackless-python">https://ep2013.europython.eu/conference/talks/the-story-of-stackless-python</a></li>
<li><a href="https://www.python.org/dev/peps/pep-0219/">https://www.python.org/dev/peps/pep-0219/</a></li>
<li><a href="https://www.python.org/dev/peps/pep-0342/">https://www.python.org/dev/peps/pep-0342/</a></li>
</ul>
    </article>
    <hr>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'shymonk';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="mailto:hellojohn201@gmail.com">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="http://github.com/shymonk">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.instagram.com/shymonk/">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <p class="copyright text-muted">
                        Copyright &copy; 2017 shymonk.
                        Powered by <a href="//getpelican.com/">Pelican</a>
                        Theme <a href="//startbootstrap.com/template-overviews/clean-blog/">Clean-Blog</a>.
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Javascript -->
        <script src="/theme/js/jquery.min.js"></script>
        <script src="/theme/js/bootstrap.min.js"></script>
        <script src="/theme/js/clean-blog.min.js"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-56451105-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>

</html>