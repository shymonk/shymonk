<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>shymonk - shymonk</title><link href="/" rel="alternate"/><link href="/feeds/shymonk.atom.xml" rel="self"/><id>/</id><updated>2017-04-01T14:15:37+08:00</updated><subtitle>In an ephemeral world some idea linger</subtitle><entry><title>Stackless Python 探秘</title><link href="/posts/2016/06/stackless-python-tan-mi/" rel="alternate"/><published>2016-06-01T22:00:00+08:00</published><updated>2017-04-01T14:15:37+08:00</updated><author><name>shymonk</name></author><id>tag:None,2016-06-01:/posts/2016/06/stackless-python-tan-mi/</id><summary type="html">&lt;p&gt;提到stackless python， 相信很多人早已对其有所耳闻。作为Python解释器的另一种实现，其设计思路对整个Python世界产生了
深远影响。坦白的讲，我并没有大规模stackless python 的应用经 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;提到stackless python， 相信很多人早已对其有所耳闻。作为Python解释器的另一种实现，其设计思路对整个Python世界产生了
深远影响。坦白的讲，我并没有大规模stackless python 的应用经验，本文意在对其背后实现原理进行探索。如果你和我一样对它感到好奇，欢迎深入阅读。&lt;/p&gt;
&lt;h1&gt;stackless历史&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;1998年， 作者Christian Tismer便开始了Stackless Python 1.0版本的开发。作为雏形版本， Tismer 首次在Python中加入了&lt;code&gt;continuation&lt;/code&gt; 这一抽象概念的实现。&lt;/li&gt;
&lt;li&gt;2000年，以Stackless Python为背景的&lt;a href="https://www.python.org/dev/peps/pep-0219/"&gt;PEP 0219&lt;/a&gt; 出现了。根据PEP的描述，Tismer希望Stackless 相关的代码能够成为Python核心的一部分。然而，他的这一提议在Python开发者当中备受争议。出于代码简洁性的考虑，一些开发者认为 stackless相关代码虽然功能强大但是晦涩难懂并且难以维护，加之其对于Jython并不兼容。最终，这一提议没有成为现实。&lt;/li&gt;
&lt;li&gt;2002年，Stackless Python 2.0版本诞生。在这一版本中，Tismer彻底重写了代码并放弃了原有的&lt;code&gt;continuation&lt;/code&gt; 实现。取而代之的是一种新的"一次性"&lt;code&gt;continuation&lt;/code&gt; - &lt;code&gt;tasklets&lt;/code&gt; 。&lt;/li&gt;
&lt;li&gt;2004年，Stackless Python 3.0版本诞生。它包含2.0版本的全部功能并加入了一个重要概念： &lt;code&gt;soft-switching&lt;/code&gt; 用于将程序的执行状态序列化（Pickling of Program State）。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;其实，早在1999年stackless PEP被提出之前，Python核心开发者Sam Rushing便开发了一个直接通过切换&lt;code&gt;C-Stack&lt;/code&gt; 实现的协程模块。然而，与stackless 一样，Python开发人员一致认为其不应该合并到Python核心代码中。理由很简单：由于各硬件平台和编译器对于&lt;code&gt;C-Stack&lt;/code&gt; 的处理不尽相同，对于Python这样一种跨平台语言来说，添加平台依赖的代码将大大增加其移植的难度。
经过多年的发展，如今的Stackless Python已经摆脱了当初的麻烦。作为一个与&lt;code&gt;CPython&lt;/code&gt;完全兼容的Package 被广大Python用户所使用。正如Tismer所说，"现在的Stackless只提供最干净的概念——&lt;code&gt;Microthreads&lt;/code&gt;， 至于那些对稀奇古怪事物不感兴趣的人根本不会真正认识Stackless，只是碰巧它更快。"&lt;/p&gt;
&lt;h1&gt;为什么使用stackless?&lt;/h1&gt;
&lt;p&gt;关于stackless，不得不提到&lt;a href="https://en.wikipedia.org/wiki/Coroutine"&gt;协程(coroutine)&lt;/a&gt;。对于大规模并发程序，传统的并发接口线程(Thread)和进程(Process)都有着较大的系统资源开销。与其相比，协程是一种更为自然并且低开销的并发解决方案。它被广泛应用于模拟器、游戏、异步IO以及其他事件驱动的编程模型中。然而，Python2.2之前的版本并没有实现对协程的支持，stackless的诞生正是为了解决这个问题。&lt;/p&gt;
&lt;h1&gt;并发模型&lt;/h1&gt;
&lt;p&gt;&lt;img alt="coroutine concurrency model" src="/images/concurrency-model.png"&gt;&lt;/p&gt;
&lt;p&gt;并发系统从本质上讲，是一系列独立的执行单元（&lt;code&gt;routine&lt;/code&gt;）在调度器的调度之下交替执行。与线程相比，协程并发模型与其最大不同之处在于：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;协程由应用程序实现调度，线程由操作系统实现调度&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;由于协程作为执行单元并发执行时，会因为主动放弃执行权限而被挂起，调度系统必须同时维护多个函数执行上下文，以实现非本地跳转（non-local jump）。&lt;/p&gt;
&lt;h1&gt;stackless是如何工作的?&lt;/h1&gt;
&lt;h2&gt;Stackfull Python&lt;/h2&gt;
&lt;p&gt;为了更好的理解&lt;code&gt;stackless&lt;/code&gt;，我们以下面这段代码为例，先简要介绍&lt;code&gt;stackfull&lt;/code&gt;的&lt;code&gt;C-Python&lt;/code&gt;解释器栈结构以及它是如何工作的。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;def a(x):
    b(x + 1)

def b(x):
    c(x * x)

def c(x):
    print &amp;#39;x=&amp;#39;, x

a(42)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;在Python shell中执行上面这段代码时，解释器中&lt;code&gt;C-stack&lt;/code&gt;和&lt;code&gt;Python-stack&lt;/code&gt;结构如下图。&lt;/p&gt;
&lt;p&gt;&lt;img alt="standard 'stackfull' python" src="/images/stackfull-python.png"&gt;&lt;/p&gt;
&lt;p&gt;Python虚拟机以&lt;code&gt;eval_code2&lt;/code&gt;作为解释函数执行&lt;code&gt;a&lt;/code&gt;时，首先通过&lt;code&gt;PyFrame_New&lt;/code&gt;构造&lt;code&gt;a&lt;/code&gt;的栈帧&lt;code&gt;frame-a&lt;/code&gt;并返回&lt;code&gt;eval_code2&lt;/code&gt;，然后执行&lt;code&gt;a&lt;/code&gt;对应的Python代码。由于&lt;code&gt;a&lt;/code&gt;嵌套调用&lt;code&gt;b&lt;/code&gt;，此时解释器递归调用&lt;code&gt;eval_code2&lt;/code&gt;并重复之前过程执行&lt;code&gt;b&lt;/code&gt;，从而形成&lt;code&gt;C-stack&lt;/code&gt;和由&lt;code&gt;PyFrameObject&lt;/code&gt;构成的&lt;code&gt;python-stack&lt;/code&gt;。&lt;/p&gt;
&lt;h2&gt;范式转换&lt;/h2&gt;
&lt;p&gt;对于&lt;code&gt;stackfull&lt;/code&gt;的标准Python而言，实现协程并发的核心在于将&lt;code&gt;Python-Stack&lt;/code&gt; 与 &lt;code&gt;C-Stack&lt;/code&gt;解耦，这种改变Python解释器执行过程的方法也被称作&lt;strong&gt;范式转换&lt;/strong&gt;。要点可以归纳为以下三个方面：&lt;/p&gt;
&lt;p&gt;1.函数栈帧执行时机    解释器执行&lt;code&gt;Python&lt;/code&gt;函数的标准范式是：为函数的&lt;code&gt;PyCodeObject&lt;/code&gt;构造一个函数栈帧&lt;code&gt;PyFrameObject&lt;/code&gt;并附带所有参数，最后通过&lt;code&gt;eval_code2&lt;/code&gt;解释执行相应的函数体直到其返回。&lt;/p&gt;
&lt;p&gt;然而，以正确的调用顺序执行所有的函数栈帧并不意味着我们必须在当前&lt;code&gt;C-stack&lt;/code&gt;嵌套层级中执行&lt;code&gt;eval_code2&lt;/code&gt;。如果我们能够避免与&lt;code&gt;C-stack&lt;/code&gt;相关的所有后续操作，就可以在函数栈帧执行前实现&lt;code&gt;C-stack&lt;/code&gt;的退栈操作，从而达到解耦的目的。&lt;/p&gt;
&lt;p&gt;2.参数生命周期
在标准python中，函数参数的引用由其上层调用者持有。这意味着只有下层函数返回后，其参数元组的引用才能被上层函数销毁。&lt;/p&gt;
&lt;p&gt;现在，让我们换一种思维方式。很明显，函数参数应该与函数栈帧有着相同的生命周期，参数元组的引用也应该同函数栈帧一起被销毁。所以，我们在&lt;code&gt;PyFrameObject&lt;/code&gt;结构中添加对参数元组的引用，就可以实现范式的转换。&lt;/p&gt;
&lt;p&gt;3.系统状态
在标准python中，执行一个函数栈帧后的返回值会存在两种情况：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;返回&lt;code&gt;PyObject&lt;/code&gt;代表函数正常执行。&lt;/li&gt;
&lt;li&gt;返回&lt;code&gt;NULL&lt;/code&gt;代表函数抛出异常。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;基于这两种基本系统状态，添加一个特殊的返回值类型&lt;code&gt;Py_UnwindToken&lt;/code&gt;作为第三种系统状态，这样我们便可以在下层栈帧被执行之前实现&lt;code&gt;C-stack&lt;/code&gt;退栈操作。&lt;/p&gt;
&lt;p&gt;由于&lt;code&gt;Py_UnwindToken&lt;/code&gt;与其他Python对象兼容，这一范式的转换对于大部分相关代码并不可见，我们只需要对执行栈帧的C函数做出修改即可。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style="text-align: left;"&gt;Return Value&lt;/th&gt;
&lt;th style="text-align: left;"&gt;系统状态&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style="text-align: left;"&gt;NULL&lt;/td&gt;
&lt;td style="text-align: left;"&gt;函数执行异常&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: left;"&gt;Py_UnwindToken&lt;/td&gt;
&lt;td style="text-align: left;"&gt;调度函数栈帧&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: left;"&gt;Other PyObject&lt;/td&gt;
&lt;td style="text-align: left;"&gt;作为正常结果返回&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h1&gt;参考资料&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://archive.is/TwQEJ"&gt;http://archive.is/TwQEJ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://web.archive.org/web/20131005114137/http://www.onlamp.com/pub/a/python/2000/10/04/stackless-intro.html"&gt;https://web.archive.org/web/20131005114137/http://www.onlamp.com/pub/a/python/2000/10/04/stackless-intro.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.onlamp.com/pub/a/python/2002/02/14/pythonnews.html"&gt;http://www.onlamp.com/pub/a/python/2002/02/14/pythonnews.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://web.archive.org/web/20120508092636/http://islab.org/stackless/2007/stackless.html"&gt;https://web.archive.org/web/20120508092636/http://islab.org/stackless/2007/stackless.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://ep2013.europython.eu/conference/talks/the-story-of-stackless-python"&gt;https://ep2013.europython.eu/conference/talks/the-story-of-stackless-python&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.python.org/dev/peps/pep-0219/"&gt;https://www.python.org/dev/peps/pep-0219/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.python.org/dev/peps/pep-0342/"&gt;https://www.python.org/dev/peps/pep-0342/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="Python"/><category term="stackless"/><category term="python"/></entry><entry><title>A Simple Guide To Setup Hostname Of 127.0.0.1 On MacOS Yosemite</title><link href="/posts/2015/11/a-simple-guide-to-setup-hostname-of-127001-on-macos-yosemite/" rel="alternate"/><published>2015-11-19T21:29:00-08:00</published><updated>2015-11-20T17:58:39+08:00</updated><author><name>shymonk</name></author><id>tag:None,2015-11-19:/posts/2015/11/a-simple-guide-to-setup-hostname-of-127001-on-macos-yosemite/</id><summary type="html">&lt;p&gt;Sometimes we have to map a hostname to loopback address 127.0.0.1
by some reasons of development. This is a simple guide to show how
to do that on MacOS 10.10 Yosemite.&lt;/p&gt;
&lt;h1&gt;Everythings starts with &lt;a href="https://en.wikipedia.org/wiki/Hosts_(file)"&gt;hosts file&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Add the following line in &lt;code&gt;/etc/hosts&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="mf"&gt;127.0.0 …&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;Sometimes we have to map a hostname to loopback address 127.0.0.1
by some reasons of development. This is a simple guide to show how
to do that on MacOS 10.10 Yosemite.&lt;/p&gt;
&lt;h1&gt;Everythings starts with &lt;a href="https://en.wikipedia.org/wiki/Hosts_(file)"&gt;hosts file&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Add the following line in &lt;code&gt;/etc/hosts&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="mf"&gt;127.0.0.1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;test&lt;/span&gt;&lt;span class="mf"&gt;.&lt;/span&gt;&lt;span class="n"&gt;domain&lt;/span&gt;&lt;span class="mf"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If your local port goes with &lt;code&gt;80&lt;/code&gt;, this is all that you need to do.
But mostly we start a develop web server with &lt;code&gt;Non-80&lt;/code&gt; port such as
&lt;code&gt;localhost:8080&lt;/code&gt;. So port forwarding comes.&lt;/p&gt;
&lt;h1&gt;Port Forwarding&lt;/h1&gt;
&lt;p&gt;From OS X 10.10, well-known &lt;a href="https://en.wikipedia.org/wiki/Ipfirewall#cite_note-2"&gt;ipfw&lt;/a&gt; has been removed completely. So we
use &lt;a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man5/pf.conf.5.html"&gt;pf&lt;/a&gt; which is the new recommanded way to do port forwarding.&lt;/p&gt;
&lt;p&gt;First, add an anchor file &lt;code&gt;/etc/pf.anchors/com.custom&lt;/code&gt; to contain the
port forwarding rule.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;rdr&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;on&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;lo0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;inet&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;proto&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;tcp&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kr"&gt;any&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mf"&gt;127.0.0.1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mf"&gt;127.0.0.1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;8080&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Then, add two lines to /etc/pf.conf to load your new rule.
It is important where these lines go.
Add this line right after rdr-anchor "com.apple/*":&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;rdr-anchor &amp;quot;custom&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Add this line directly after &lt;code&gt;load anchor "com.apple"&lt;/code&gt; from `/etc/pf.anchors/com.apple":&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nb"&gt;load&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;anchor&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;pow&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/etc/pf.anchors/com.custom&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next, reload the rules into pf by running&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sudo pfctl -f /etc/pf.conf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Finally, enable &lt;code&gt;pf&lt;/code&gt; by running&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sudo pfctl -e
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now, input &lt;code&gt;test.domain.com&lt;/code&gt; into your browser address bar, it will works.&lt;/p&gt;</content><category term="posts"/></entry><entry><title>SSH from A through B to C, using private key on B on Mac OS X</title><link href="/posts/2015/07/ssh-from-a-through-b-to-c-using-private-key-on-b-on-mac-os-x/" rel="alternate"/><published>2015-07-07T23:29:00-08:00</published><updated>2017-03-21T17:34:59+08:00</updated><author><name>shymonk</name></author><id>tag:None,2015-07-07:/posts/2015/07/ssh-from-a-through-b-to-c-using-private-key-on-b-on-mac-os-x/</id><summary type="html">&lt;h1&gt;Schematic:&lt;/h1&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;ssh&lt;/span&gt;&lt;span class="w"&gt;       &lt;/span&gt;&lt;span class="n"&gt;ssh&lt;/span&gt;
&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;------&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;------&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;C&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="o"&gt;^&lt;/span&gt;&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="o"&gt;^&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;using&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;s   using B&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ssh&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="w"&gt;     &lt;/span&gt;&lt;span class="n"&gt;ssh&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h1&gt;Preconditions:&lt;/h1&gt;
&lt;p&gt;A is running ssh-agent;
A can access B;
B can access C;
A's ssh public key is present in &lt;code&gt;B:~/.ssh/authorized_keys&lt;/code&gt;
B's ssh public key is present in &lt;code&gt;C:~/.ssh/authorized_keys&lt;/code&gt;&lt;/p&gt;
&lt;h1&gt;HowTo …&lt;/h1&gt;</summary><content type="html">&lt;h1&gt;Schematic:&lt;/h1&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;ssh&lt;/span&gt;&lt;span class="w"&gt;       &lt;/span&gt;&lt;span class="n"&gt;ssh&lt;/span&gt;
&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;------&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;------&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;C&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="o"&gt;^&lt;/span&gt;&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="o"&gt;^&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;using&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;s   using B&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ssh&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="w"&gt;     &lt;/span&gt;&lt;span class="n"&gt;ssh&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h1&gt;Preconditions:&lt;/h1&gt;
&lt;p&gt;A is running ssh-agent;
A can access B;
B can access C;
A's ssh public key is present in &lt;code&gt;B:~/.ssh/authorized_keys&lt;/code&gt;
B's ssh public key is present in &lt;code&gt;C:~/.ssh/authorized_keys&lt;/code&gt;&lt;/p&gt;
&lt;h1&gt;HowTo&lt;/h1&gt;
&lt;h2&gt;Method 1 (Use ssh -t)&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;A$ ssh -t B ssh C
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Method 2 (Use ProxyCommand)&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;A$ vim ~/.ssh/config

Host C
ProxyCommand ssh -o &amp;#39;ForwardAgent yes&amp;#39; B &amp;#39;ssh-add &amp;amp;&amp;amp; nc %h %p&amp;#39;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If your ssh private key on B is in a non-standard location(not &lt;code&gt;~/.ssh/id_rsa&lt;/code&gt;), add its path after ssh-add.
You should now be able to access C from A:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nv"&gt;A&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;ssh&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;C&lt;/span&gt;
&lt;span class="nv"&gt;C&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h1&gt;Debug&lt;/h1&gt;
&lt;p&gt;Use multiple -v option to debugging connection, authentication, and configuration problems.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;A$ ssh -vvv C
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h1&gt;Example&lt;/h1&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$&lt;span class="w"&gt; &lt;/span&gt;cat&lt;span class="w"&gt; &lt;/span&gt;~/.ssh/config
Host&lt;span class="w"&gt; &lt;/span&gt;sshproxy
HostName&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;192&lt;/span&gt;.168.10.10
User&lt;span class="w"&gt; &lt;/span&gt;root

Host&lt;span class="w"&gt; &lt;/span&gt;target
HostName&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;192&lt;/span&gt;.168.0.170
User&lt;span class="w"&gt; &lt;/span&gt;root
ProxyCommand&lt;span class="w"&gt; &lt;/span&gt;ssh&lt;span class="w"&gt; &lt;/span&gt;-o&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ForwardAgent yes&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sohuzk&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ssh-add &amp;amp;&amp;amp; nc %h %p&amp;#39;&lt;/span&gt;

$&lt;span class="w"&gt; &lt;/span&gt;ssh&lt;span class="w"&gt; &lt;/span&gt;target&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;tail -f /var/log/example.log&amp;#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content><category term="posts"/></entry><entry><title>How To Customize Save In Django Admin Inline Form</title><link href="/posts/2014/10/how-to-customize-save-in-django-admin-inline-form/" rel="alternate"/><published>2014-10-01T23:00:00-08:00</published><updated>2016-04-12T22:54:05+08:00</updated><author><name>shymonk</name></author><id>tag:None,2014-10-01:/posts/2014/10/how-to-customize-save-in-django-admin-inline-form/</id><summary type="html">&lt;h1&gt;Background&lt;/h1&gt;
&lt;p&gt;This is a common case in django ORM.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.db&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Author&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CharField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Book&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CharField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;author&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ForeignKey&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Author&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;As a CMS, we are also required to provide a feature to …&lt;/p&gt;</summary><content type="html">&lt;h1&gt;Background&lt;/h1&gt;
&lt;p&gt;This is a common case in django ORM.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.db&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Author&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CharField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Book&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CharField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;author&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ForeignKey&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Author&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;As a CMS, we are also required to provide a feature to create Author and
several Books for him together. So, the &lt;code&gt;admin&lt;/code&gt; class is here:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;forms&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;AuthorAdmin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;form&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;AuthorForm&lt;/span&gt;&lt;span class="p"&gt;,]&lt;/span&gt;
    &lt;span class="n"&gt;inlines&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;BookInline&lt;/span&gt;&lt;span class="p"&gt;,]&lt;/span&gt;
    &lt;span class="n"&gt;form_layout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;BookInline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Book&lt;/span&gt;
    &lt;span class="n"&gt;form&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;BookForm&lt;/span&gt;
    &lt;span class="n"&gt;form_layout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;AuthorForm&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;forms&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ModelForm&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Author&lt;/span&gt;
&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;BookForm&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;forms&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ModelForm&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Book&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;With this &lt;code&gt;BookInline&lt;/code&gt;, you can get all things done without doubt.
But let't think about a special case:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Assume that there's another Model &lt;code&gt;Press&lt;/code&gt;, every author belongs to
a press.&lt;/p&gt;
&lt;p&gt;class Press(models.Model):
    &amp;#x2026;&lt;/p&gt;
&lt;p&gt;When creating a author and add/update book to him, you also need
to create/update the same one for the press, synchronously. May be
it is a obvious bad design, but just a example.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;So, how to do that?&lt;/p&gt;
&lt;h1&gt;HowTo&lt;/h1&gt;
&lt;p&gt;Straightforward to say, you should customize &lt;code&gt;FormSet&lt;/code&gt; for &lt;code&gt;BookInline&lt;/code&gt;
and override these two methods:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;save_new_objects&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;save_existing_objects&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So, the &lt;code&gt;BookInline&lt;/code&gt; will becomes&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.forms.models&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;BaseInlineFormSet&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;BookInline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Book&lt;/span&gt;
    &lt;span class="n"&gt;form&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;BookForm&lt;/span&gt;
    &lt;span class="n"&gt;fromset&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;BookFormSet&lt;/span&gt;
    &lt;span class="n"&gt;form_layout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;BookInlineFormSet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BaseInlineFormSet&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;save_new_objects&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;saved_instances&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BookInlineFormSet&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save_new_objects&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="c1"&gt;# create book for press&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;saved_instances&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;save_existing_objects&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;saved_instances&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BookInlineFormSet&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save_existing_objects&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="c1"&gt;# update book for press&lt;/span&gt;
      &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;saved_instances&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h1&gt;Why&lt;/h1&gt;
&lt;h2&gt;Traps&lt;/h2&gt;
&lt;p&gt;Inertia of thinking, we can override &lt;code&gt;save&lt;/code&gt; function of &lt;code&gt;BookForm&lt;/code&gt;
like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="n"&gt;BookForm&lt;/span&gt;(&lt;span class="n"&gt;models&lt;/span&gt;.&lt;span class="n"&gt;ModelForm&lt;/span&gt;):
    ...

    &lt;span class="n"&gt;def&lt;/span&gt; &lt;span class="n"&gt;save&lt;/span&gt;(&lt;span class="nb"&gt;self&lt;/span&gt;, &lt;span class="n"&gt;commit&lt;/span&gt;=&lt;span class="nb"&gt;True&lt;/span&gt;):
        &lt;span class="n"&gt;instance&lt;/span&gt; = &lt;span class="n"&gt;super&lt;/span&gt;(&lt;span class="n"&gt;BookForm&lt;/span&gt;, &lt;span class="nb"&gt;self&lt;/span&gt;).&lt;span class="n"&gt;save&lt;/span&gt;(&lt;span class="n"&gt;commit&lt;/span&gt;)
        &lt;span class="c1"&gt;# do anything you want to sync book for Press&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In fact that is a &lt;strong&gt;mistake&lt;/strong&gt; I've made before, because &lt;code&gt;save&lt;/code&gt; function of
&lt;code&gt;BookForm&lt;/code&gt; instance is called with &lt;code&gt;commit=False&lt;/code&gt;, it means book
instance is lacking attribute values. So, it can't be copied or do
anything else. I will give some hints to show that how django does it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;django&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;forms&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt;

&lt;span class="n"&gt;class&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;BaseInlineFormSet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BaseModelFormSet&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;def&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;save_new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;form&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;False&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;so&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;we&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;can&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;assign&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;the&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;parent&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;afterwards&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;save&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;the&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;form&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;pk_value&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;getattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;self&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;self&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fk&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;rel&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;field_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;setattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;self&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fk&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_attname&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;getattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pk_value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;pk&lt;/span&gt;&lt;span class="p"&gt;&amp;#39;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;pk_value&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nl"&gt;commit:&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;form&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save_m2m&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;can&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;be&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;called&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;via&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;the&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;formset&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;later&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;on&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;False&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;and&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;hasattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;form&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;save_m2m&lt;/span&gt;&lt;span class="p"&gt;&amp;#39;)&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="n"&gt;form&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save_m2m&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Moreover, it is worth mention that although &lt;code&gt;obj's&lt;/code&gt; Foreignkey is saved above,&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;setattr(obj, self.fk.get_attname(), getattr(pk_value, &amp;#39;pk&amp;#39;, pk_value))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;you can not access it directly as following at downstream&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;def save_new_objects(self, commit=True):
    saved_instances = super(BookInlineFormSet, self).save_new_objects(commit)
    if commit:
        book = saved_instances[0]
        author = book.author  # wrong way
    return saved_instances
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Because django probably already &lt;strong&gt;cached&lt;/strong&gt; a invalid author before.
In order to get a "fresh" author, use the primary key value of the
related object as stored in the db field instead.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;def save_new_objects(self, commit=True):
    saved_instances = super(BookInlineFormSet, self).save_new_objects(commit)
    if commit:
        book = saved_instances[0]
        author = Author.objects.get(pk=book.author_id)  # correct way
    return saved_instances
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;About caching ForeignKey in django, see &lt;a href="https://docs.djangoproject.com/en/dev/topics/db/queries/#one-to-many-relationships"&gt;django doc&lt;/a&gt; for more details.&lt;/p&gt;</content><category term="posts"/></entry></feed>