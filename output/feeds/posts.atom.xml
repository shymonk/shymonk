<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>shymonk - posts</title><link href="http://shymonk.com/" rel="alternate"></link><link href="http://shymonk.com/feeds/posts.atom.xml" rel="self"></link><id>http://shymonk.com/</id><updated>2015-11-19T21:29:00-08:00</updated><entry><title>A Simple Guide To Setup Hostname Of 127.0.0.1 On MacOS Yosemite</title><link href="http://shymonk.com/posts/2015/11/a-simple-guide-to-setup-hostname-of-127001-on-macos-yosemite/" rel="alternate"></link><published>2015-11-19T21:29:00-08:00</published><updated>2015-11-19T21:29:00-08:00</updated><author><name>shymonk</name></author><id>tag:shymonk.com,2015-11-19:/posts/2015/11/a-simple-guide-to-setup-hostname-of-127001-on-macos-yosemite/</id><summary type="html">&lt;p&gt;Sometimes we have to map a hostname to loopback address 127.0.0.1
by some reasons of development. This is a simple guide to show how
to do that on MacOS 10.10 Yosemite.&lt;/p&gt;
&lt;h1&gt;Everythings starts with &lt;a href="https://en.wikipedia.org/wiki/Hosts_(file)"&gt;hosts file&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Add the following line in &lt;code&gt;/etc/hosts&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;127.0.0 …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;Sometimes we have to map a hostname to loopback address 127.0.0.1
by some reasons of development. This is a simple guide to show how
to do that on MacOS 10.10 Yosemite.&lt;/p&gt;
&lt;h1&gt;Everythings starts with &lt;a href="https://en.wikipedia.org/wiki/Hosts_(file)"&gt;hosts file&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Add the following line in &lt;code&gt;/etc/hosts&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;127.0.0.1 test.domain.com
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If your local port goes with &lt;code&gt;80&lt;/code&gt;, this is all that you need to do.
But mostly we start a develop web server with &lt;code&gt;Non-80&lt;/code&gt; port such as
&lt;code&gt;localhost:8080&lt;/code&gt;. So port forwarding comes.&lt;/p&gt;
&lt;h1&gt;Port Forwarding&lt;/h1&gt;
&lt;p&gt;From OS X 10.10, well-known &lt;a href="https://en.wikipedia.org/wiki/Ipfirewall#cite_note-2"&gt;ipfw&lt;/a&gt; has been removed completely. So we
use &lt;a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man5/pf.conf.5.html"&gt;pf&lt;/a&gt; which is the new recommanded way to do port forwarding.&lt;/p&gt;
&lt;p&gt;First, add an anchor file &lt;code&gt;/etc/pf.anchors/com.custom&lt;/code&gt; to contain the
port forwarding rule.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;rdr pass on lo0 inet proto tcp from any to 127.0.0.1 port 80 -&amp;gt; 127.0.0.1 port 8080
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then, add two lines to /etc/pf.conf to load your new rule.
It is important where these lines go.
Add this line right after rdr-anchor "com.apple/*":&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;rdr-anchor &amp;quot;custom&amp;quot;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Add this line directly after &lt;code&gt;load anchor "com.apple"&lt;/code&gt; from `/etc/pf.anchors/com.apple":&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;load anchor &amp;quot;pow&amp;quot; from &amp;quot;/etc/pf.anchors/com.custom&amp;quot;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Next, reload the rules into pf by running&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo pfctl -f /etc/pf.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Finally, enable &lt;code&gt;pf&lt;/code&gt; by running&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo pfctl -e
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now, input &lt;code&gt;test.domain.com&lt;/code&gt; into your browser address bar, it will works.&lt;/p&gt;</content></entry><entry><title>SSH from A through B to C, using private key on B on Mac OS X</title><link href="http://shymonk.com/posts/2015/07/ssh-from-a-through-b-to-c-using-private-key-on-b-on-mac-os-x/" rel="alternate"></link><published>2015-07-07T23:29:00-08:00</published><updated>2015-07-07T23:29:00-08:00</updated><author><name>shymonk</name></author><id>tag:shymonk.com,2015-07-07:/posts/2015/07/ssh-from-a-through-b-to-c-using-private-key-on-b-on-mac-os-x/</id><summary type="html">&lt;h1&gt;Schematic:&lt;/h1&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    ssh       ssh
A ------&amp;gt; B ------&amp;gt; C
    ^          ^
 using A&amp;#39;s   using B&amp;#39;s
 ssh key     ssh key
&lt;/pre&gt;&lt;/div&gt;


&lt;h1&gt;Preconditions:&lt;/h1&gt;
&lt;p&gt;A is running ssh-agent;
A can access B;
B can access C;
A's ssh public key is present in &lt;code&gt;B:~/.ssh/authorized_keys&lt;/code&gt;
B's ssh public key is present in &lt;code&gt;C:~/.ssh/authorized_keys&lt;/code&gt;&lt;/p&gt;
&lt;h1&gt;HowTo …&lt;/h1&gt;</summary><content type="html">&lt;h1&gt;Schematic:&lt;/h1&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    ssh       ssh
A ------&amp;gt; B ------&amp;gt; C
    ^          ^
 using A&amp;#39;s   using B&amp;#39;s
 ssh key     ssh key
&lt;/pre&gt;&lt;/div&gt;


&lt;h1&gt;Preconditions:&lt;/h1&gt;
&lt;p&gt;A is running ssh-agent;
A can access B;
B can access C;
A's ssh public key is present in &lt;code&gt;B:~/.ssh/authorized_keys&lt;/code&gt;
B's ssh public key is present in &lt;code&gt;C:~/.ssh/authorized_keys&lt;/code&gt;&lt;/p&gt;
&lt;h1&gt;HowTo&lt;/h1&gt;
&lt;h2&gt;Method 1 (Use ssh -t)&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;A$ ssh -t B ssh C
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Method 2 (Use ProxyCommand)&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;A$ vim ~/.ssh/config

Host C
ProxyCommand ssh -o &amp;#39;ForwardAgent yes&amp;#39; B &amp;#39;ssh-add &amp;amp;&amp;amp; nc %h %p&amp;#39;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If your ssh private key on B is in a non-standard location(not &lt;code&gt;~/.ssh/id_rsa&lt;/code&gt;), add its path after ssh-add.
You should now be able to access C from A:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;A$ ssh C
C$
&lt;/pre&gt;&lt;/div&gt;


&lt;h1&gt;Debug&lt;/h1&gt;
&lt;p&gt;Use multiple -v option to debugging connection, authentication, and configuration problems.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;A$ ssh -vvv C
&lt;/pre&gt;&lt;/div&gt;


&lt;h1&gt;Example&lt;/h1&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ cat ~/.ssh/config
Host sshproxy
HostName &lt;span class="m"&gt;192&lt;/span&gt;.168.10.10
User root

Host target
HostName &lt;span class="m"&gt;192&lt;/span&gt;.168.0.170
User root
ProxyCommand ssh -o &lt;span class="s1"&gt;&amp;#39;ForwardAgent yes&amp;#39;&lt;/span&gt; sohuzk &lt;span class="s1"&gt;&amp;#39;ssh-add &amp;amp;&amp;amp; nc %h %p&amp;#39;&lt;/span&gt;

$ ssh target &lt;span class="s1"&gt;&amp;#39;tail -f /var/log/example.log&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;</content></entry><entry><title>How To Customize Save In Django Admin Inline Form</title><link href="http://shymonk.com/posts/2014/10/how-to-customize-save-in-django-admin-inline-form/" rel="alternate"></link><published>2014-10-01T23:00:00-08:00</published><updated>2014-10-01T23:00:00-08:00</updated><author><name>shymonk</name></author><id>tag:shymonk.com,2014-10-01:/posts/2014/10/how-to-customize-save-in-django-admin-inline-form/</id><summary type="html">&lt;h1&gt;Background&lt;/h1&gt;
&lt;p&gt;This is a common case in django ORM.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.db&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Author&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CharField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Book&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CharField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;author&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ForeignKey&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Author&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As a CMS, we are also required to provide a feature to …&lt;/p&gt;</summary><content type="html">&lt;h1&gt;Background&lt;/h1&gt;
&lt;p&gt;This is a common case in django ORM.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.db&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Author&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CharField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Book&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CharField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;author&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ForeignKey&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Author&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As a CMS, we are also required to provide a feature to create Author and
several Books for him together. So, the &lt;code&gt;admin&lt;/code&gt; class is here:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;forms&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;AuthorAdmin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;form&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;AuthorForm&lt;/span&gt;&lt;span class="p"&gt;,]&lt;/span&gt;
    &lt;span class="n"&gt;inlines&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;BookInline&lt;/span&gt;&lt;span class="p"&gt;,]&lt;/span&gt;
    &lt;span class="n"&gt;form_layout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;BookInline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Book&lt;/span&gt;
    &lt;span class="n"&gt;form&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;BookForm&lt;/span&gt;
    &lt;span class="n"&gt;form_layout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;AuthorForm&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;forms&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ModelForm&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Author&lt;/span&gt;
&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;BookForm&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;forms&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ModelForm&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Book&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;With this &lt;code&gt;BookInline&lt;/code&gt;, you can get all things done without doubt.
But let't think about a special case:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Assume that there's another Model &lt;code&gt;Press&lt;/code&gt;, every author belongs to
a press.&lt;/p&gt;
&lt;p&gt;class Press(models.Model):
    &amp;#x2026;&lt;/p&gt;
&lt;p&gt;When creating a author and add/update book to him, you also need
to create/update the same one for the press, synchronously. May be
it is a obvious bad design, but just a example.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;So, how to do that?&lt;/p&gt;
&lt;h1&gt;HowTo&lt;/h1&gt;
&lt;p&gt;Straightforward to say, you should customize &lt;code&gt;FormSet&lt;/code&gt; for &lt;code&gt;BookInline&lt;/code&gt;
and override these two methods:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;save_new_objects&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;save_existing_objects&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So, the &lt;code&gt;BookInline&lt;/code&gt; will becomes&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.forms.models&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;BaseInlineFormSet&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;BookInline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Book&lt;/span&gt;
    &lt;span class="n"&gt;form&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;BookForm&lt;/span&gt;
    &lt;span class="n"&gt;fromset&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;BookFormSet&lt;/span&gt;
    &lt;span class="n"&gt;form_layout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;BookInlineFormSet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BaseInlineFormSet&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;save_new_objects&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;saved_instances&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BookInlineFormSet&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save_new_objects&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="c1"&gt;# create book for press&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;saved_instances&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;save_existing_objects&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;saved_instances&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BookInlineFormSet&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save_existing_objects&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="c1"&gt;# update book for press&lt;/span&gt;
      &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;saved_instances&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h1&gt;Why&lt;/h1&gt;
&lt;h2&gt;Traps&lt;/h2&gt;
&lt;p&gt;Inertia of thinking, we can override &lt;code&gt;save&lt;/code&gt; function of &lt;code&gt;BookForm&lt;/code&gt;
like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kr"&gt;class&lt;/span&gt; &lt;span class="nx"&gt;BookForm&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;models&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;ModelForm&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
    &lt;span class="p"&gt;...&lt;/span&gt;

    &lt;span class="nx"&gt;def&lt;/span&gt; &lt;span class="nx"&gt;save&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nx"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
        &lt;span class="nx"&gt;instance&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kr"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;BookForm&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;self&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nx"&gt;save&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;commit&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="nx"&gt;anything&lt;/span&gt; &lt;span class="nx"&gt;you&lt;/span&gt; &lt;span class="nx"&gt;want&lt;/span&gt; &lt;span class="nx"&gt;to&lt;/span&gt; &lt;span class="nx"&gt;sync&lt;/span&gt; &lt;span class="nx"&gt;book&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="nx"&gt;Press&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In fact that is a &lt;strong&gt;mistake&lt;/strong&gt; I've made before, because &lt;code&gt;save&lt;/code&gt; function of
&lt;code&gt;BookForm&lt;/code&gt; instance is called with &lt;code&gt;commit=False&lt;/code&gt;, it means book
instance is lacking attribute values. So, it can't be copied or do
anything else. I will give some hints to show that how django does it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="nx"&gt;django&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="nx"&gt;forms&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="nx"&gt;models&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;py&lt;/span&gt;

&lt;span class="kr"&gt;class&lt;/span&gt; &lt;span class="nx"&gt;BaseInlineFormSet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;BaseModelFormSet&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
    &lt;span class="p"&gt;...&lt;/span&gt;
    &lt;span class="nx"&gt;def&lt;/span&gt; &lt;span class="nx"&gt;save_new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;form&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nx"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
        &lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="nx"&gt;Use&lt;/span&gt; &lt;span class="nx"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nx"&gt;False&lt;/span&gt; &lt;span class="nx"&gt;so&lt;/span&gt; &lt;span class="nx"&gt;we&lt;/span&gt; &lt;span class="nx"&gt;can&lt;/span&gt; &lt;span class="nx"&gt;assign&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;parent&lt;/span&gt; &lt;span class="nx"&gt;key&lt;/span&gt; &lt;span class="nx"&gt;afterwards&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;then&lt;/span&gt;
        &lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="nx"&gt;save&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;object&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
        &lt;span class="nx"&gt;obj&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;form&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;save&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nx"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nx"&gt;pk_value&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;getattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;self&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;instance&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;self&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fk&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;rel&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;field_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nx"&gt;setattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;self&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fk&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;get_attname&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="nx"&gt;getattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;pk_value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;pk&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;pk_value&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;commit&lt;/span&gt;:
            &lt;span class="kt"&gt;obj.save&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="nx"&gt;form&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;save_m2m&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="nx"&gt;can&lt;/span&gt; &lt;span class="nx"&gt;be&lt;/span&gt; &lt;span class="nx"&gt;called&lt;/span&gt; &lt;span class="nx"&gt;via&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;formset&lt;/span&gt; &lt;span class="nx"&gt;later&lt;/span&gt; &lt;span class="nx"&gt;on&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;commit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nx"&gt;False&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;commit&lt;/span&gt; &lt;span class="nx"&gt;and&lt;/span&gt; &lt;span class="nx"&gt;hasattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;form&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;save_m2m&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
            &lt;span class="nx"&gt;form&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;save_m2m&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;obj&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Moreover, it is worth mention that although &lt;code&gt;obj's&lt;/code&gt; Foreignkey is saved above,&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;setattr(obj, self.fk.get_attname(), getattr(pk_value, &amp;#39;pk&amp;#39;, pk_value))
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;you can not access it directly as following at downstream&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;def save_new_objects(self, commit=True):
    saved_instances = super(BookInlineFormSet, self).save_new_objects(commit)
    if commit:
        book = saved_instances[0]
        author = book.author  # wrong way
    return saved_instances
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Because django probably already &lt;strong&gt;cached&lt;/strong&gt; a invalid author before.
In order to get a "fresh" author, use the primary key value of the
related object as stored in the db field instead.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;def save_new_objects(self, commit=True):
    saved_instances = super(BookInlineFormSet, self).save_new_objects(commit)
    if commit:
        book = saved_instances[0]
        author = Author.objects.get(pk=book.author_id)  # correct way
    return saved_instances
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;About caching ForeignKey in django, see &lt;a href="https://docs.djangoproject.com/en/dev/topics/db/queries/#one-to-many-relationships"&gt;django doc&lt;/a&gt; for more details.&lt;/p&gt;</content></entry></feed>